# Example GitLab CI/CD Pipeline for Redis Enterprise GitOps
#
# This pipeline validates configuration changes before they are merged
# Copy this file to .gitlab-ci.yml and customize for your needs

stages:
  - validate
  - security-scan

variables:
  KUSTOMIZE_VERSION: "5.0.0"

# Validation job
validate:
  stage: validate
  image: alpine:latest
  before_script:
    # Install required tools
    - apk add --no-cache bash curl grep
    
    # Install kustomize
    - curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
    - mv kustomize /usr/local/bin/
    
    # Install yamllint (optional)
    - apk add --no-cache yamllint || true
  
  script:
    # Make validation script executable
    - chmod +x ci/validate.sh
    
    # Run validation
    - ./ci/validate.sh
  
  rules:
    # Run on merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    # Run on main branch
    - if: '$CI_COMMIT_BRANCH == "main"'

# YAML linting job
yaml-lint:
  stage: validate
  image: python:3.11-alpine
  before_script:
    - pip install yamllint
  script:
    - yamllint -c ci/yamllint-config.yaml .
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# Security scanning (example using kubesec)
security-scan:
  stage: security-scan
  image: alpine:latest
  before_script:
    - apk add --no-cache bash curl
    - curl -sSL https://github.com/controlplaneio/kubesec/releases/download/v2.13.0/kubesec_linux_amd64.tar.gz | tar xz
    - mv kubesec /usr/local/bin/
  script:
    # Scan rendered manifests
    - kustomize build orders-redis-dev | kubesec scan -
    - kustomize build orders-redis/overlays/dev | kubesec scan -
    - kustomize build orders-redis/overlays/nonprod | kubesec scan -
    - kustomize build orders-redis/overlays/prod | kubesec scan -
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# Policy validation (example using OPA/Conftest)
# Uncomment and customize if you use OPA policies
# policy-check:
#   stage: validate
#   image: openpolicyagent/conftest:latest
#   script:
#     - conftest test orders-redis-dev/*.yaml
#     - conftest test orders-redis/overlays/dev/*.yaml
#     - conftest test orders-redis/overlays/nonprod/*.yaml
#     - conftest test orders-redis/overlays/prod/*.yaml
#   rules:
#     - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

