# TLS Certificate Setup for Redis Enterprise Cluster

This guide explains how to add TLS certificates to the Redis Enterprise Cluster after initial deployment.

## ğŸ“‹ Overview

The Redis Cluster is deployed in two phases:
1. **Phase 1**: Deploy cluster WITHOUT TLS certificate (faster startup)
2. **Phase 2**: Generate certificate and update cluster to use TLS

---

## ğŸš€ Phase 1: Deploy Cluster Without TLS

The current `01-redis-cluster.yaml` is configured WITHOUT TLS certificate.

```bash
# Apply the ArgoCD Application
oc apply -f demo-gitops-argocd/argocd-app.yaml

# Wait for cluster to be ready
oc get rec -n redis-demo -w
```

**Expected State**: Cluster running with default self-signed certificates

---

## ğŸ” Phase 2: Add TLS Certificate

### Step 1: Generate Certificate

Use the provided script to generate a self-signed certificate:

```bash
cd demo-gitops-argocd
./generate-cert.sh
```

This creates:
- `certs/tls.crt` - Certificate
- `certs/tls.key` - Private key
- `00-tls-secret.yaml` - Kubernetes Secret

### Step 2: Apply the Certificate Secret

```bash
oc apply -f demo-gitops-argocd/00-tls-secret.yaml
```

Verify the secret was created:

```bash
oc get secret redis-cluster-tls -n redis-demo
```

### Step 3: Update Redis Cluster to Use Certificate

Edit `01-redis-cluster.yaml` and uncomment the certificate section:

```yaml
  # TLS Certificate Configuration
  certificates:
    apiCertificateSecretName: redis-cluster-tls
```

Or use the example file:

```bash
cp demo-gitops-argocd/01-redis-cluster-with-tls.yaml.example demo-gitops-argocd/01-redis-cluster.yaml
```

### Step 4: Commit and Push

```bash
git add demo-gitops-argocd/
git commit -m "Add TLS certificate to Redis Cluster"
git push
```

ArgoCD will detect the change and update the cluster.

### Step 5: Verify TLS is Active

```bash
# Check cluster status
oc get rec demo-cluster -n redis-demo -o yaml | grep -A 5 certificates

# Test API with certificate
oc get route demo-cluster-ui -n redis-demo -o jsonpath='{.spec.host}'
curl -k https://<route-host>:9443
```

---

## ğŸ“ Notes

- The cluster will perform a rolling restart when TLS is added
- Existing databases will continue to work during the update
- The certificate is valid for 365 days
- For production, use a certificate from a trusted CA

---

## ğŸ”„ Rollback

To remove TLS certificate:

```bash
# Edit 01-redis-cluster.yaml and comment out the certificates section
# Commit and push
git add demo-gitops-argocd/01-redis-cluster.yaml
git commit -m "Remove TLS certificate from Redis Cluster"
git push
```

---

## ğŸ“š Reference Files

- `01-redis-cluster.yaml` - Current cluster config (no TLS)
- `01-redis-cluster-with-tls.yaml.example` - Example with TLS enabled
- `00-tls-secret.yaml` - Certificate secret (generated by script)
- `generate-cert.sh` - Certificate generation script

