---
# Job to create Secret with Grafana ServiceAccount token
# Purpose: Extract token from ServiceAccount and store in Secret for GrafanaDatasource
# This Job runs once and creates a Secret that the GrafanaDatasource references
# Managed by: Platform Team
# Sync Wave: 0 - Must run BEFORE GrafanaDatasource (wave 1)

apiVersion: batch/v1
kind: Job
metadata:
  name: grafana-token-secret-creator
  namespace: openshift-monitoring
  labels:
    app: grafana
    component: token-creator
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300  # Clean up Job after 5 minutes
  template:
    metadata:
      labels:
        app: grafana
        component: token-creator
    spec:
      serviceAccountName: grafana-serviceaccount
      restartPolicy: OnFailure
      containers:
      - name: create-secret
        image: registry.redhat.io/openshift4/ose-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          
          echo "Creating token for grafana-serviceaccount..."
          TOKEN=$(oc create token grafana-serviceaccount -n openshift-monitoring --duration=87600h)

          echo "Creating Secret with token (with Bearer prefix for Authorization header)..."
          oc create secret generic grafana-prometheus-token \
            --from-literal=token="Bearer $TOKEN" \
            --dry-run=client -o yaml | oc apply -f -
          
          echo "Secret created successfully!"
          oc get secret grafana-prometheus-token -n openshift-monitoring

