---
# GrafanaDatasource for Prometheus via Thanos Querier
# Purpose: Automatically configure Prometheus as a data source in Grafana
# This enables the Redis Enterprise dashboards to query metrics from Prometheus
# Uses Thanos Querier which provides unified access to Prometheus metrics
# Managed by: Platform Team
# Note: This datasource uses valuesFrom to reference the Secret with the Bearer token
# Sync Wave: 1 - Must be created AFTER Job (wave 0) creates the Secret

apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDatasource
metadata:
  name: prometheus-redis-enterprise
  namespace: openshift-monitoring
  labels:
    app: grafana
    component: datasource
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  instanceSelector:
    matchLabels:
      dashboards: "grafana"
  valuesFrom:
    - targetPath: "secureJsonData.httpHeaderValue1"
      valueFrom:
        secretKeyRef:
          name: grafana-prometheus-token
          key: token
  datasource:
    name: Prometheus (Redis Enterprise)
    type: prometheus
    access: proxy
    url: https://thanos-querier.openshift-monitoring.svc:9091
    isDefault: true
    jsonData:
      timeInterval: "30s"
      httpMethod: "POST"
      tlsSkipVerify: true
      httpHeaderName1: "Authorization"
    secureJsonData:
      httpHeaderValue1: "${token}"
    editable: true

