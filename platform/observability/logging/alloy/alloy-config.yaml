---
# ConfigMap with Grafana Alloy configuration
# This configures Alloy to collect Redis Enterprise internal logs
# and forward them to Loki
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-alloy-config
  namespace: openshift-logging
  annotations:
    argocd.argoproj.io/sync-wave: "14"
data:
  config.alloy: |
    // Grafana Alloy Configuration for Redis Enterprise Internal Logs
    // Official approach from: https://grafana.com/docs/grafana-cloud/monitor-infrastructure/integrations/integration-reference/integration-redis-enterprise/
    
    // ============================================================================
    // DISCOVERY: Find Redis Enterprise pods
    // ============================================================================
    
    discovery.kubernetes "redis_pods" {
      role = "pod"
      
      // Only discover pods in Redis namespaces
      namespaces {
        names = [
          "redis-enterprise",
          "redis-team1-dev",
          "redis-team1-prod",
          "redis-team2-dev",
          "redis-team2-prod",
        ]
      }
      
      // Filter for Redis Enterprise pods
      selectors {
        role  = "pod"
        label = "app=redis-enterprise"
      }
    }
    
    // ============================================================================
    // FILE MATCH: Locate Redis internal log files
    // ============================================================================
    
    local.file_match "redis_internal_logs" {
      path_targets = discovery.kubernetes.redis_pods.targets
      
      // Sync period - how often to check for new files
      sync_period = "10s"
    }
    
    // ============================================================================
    // RELABEL: Add labels to logs
    // ============================================================================
    
    discovery.relabel "redis_logs" {
      targets = local.file_match.redis_internal_logs.targets
      
      // Keep namespace label
      rule {
        source_labels = ["__meta_kubernetes_namespace"]
        target_label  = "namespace"
      }
      
      // Keep pod name label
      rule {
        source_labels = ["__meta_kubernetes_pod_name"]
        target_label  = "pod"
      }
      
      // Keep node name label
      rule {
        source_labels = ["__meta_kubernetes_pod_node_name"]
        target_label  = "node"
      }
      
      // Add cluster label (extract from namespace or pod name)
      rule {
        source_labels = ["__meta_kubernetes_pod_label_redis_enterprise_cluster"]
        target_label  = "redis_cluster"
      }
      
      // Add job label
      rule {
        replacement  = "integrations/redis-enterprise-internal"
        target_label = "job"
      }
      
      // Set log path to Redis internal logs directory
      rule {
        source_labels = ["__meta_kubernetes_pod_uid", "__meta_kubernetes_pod_container_name"]
        separator     = "/"
        regex         = "(.*)/(.*)"
        replacement   = "/var/log/pods/*${1}/*${2}/*.log"
        target_label  = "__path__"
      }
    }
    
    // ============================================================================
    // LOKI SOURCE: Read log files
    // ============================================================================
    
    loki.source.file "redis_internal_logs" {
      targets    = discovery.relabel.redis_logs.output
      forward_to = [loki.write.loki_endpoint.receiver]
      
      // Tail from end of file (don't read historical logs on startup)
      tail_from_end = true
      
      // Encoding
      encoding = "UTF-8"
    }
    
    // ============================================================================
    // LOKI WRITE: Forward logs to Loki
    // ============================================================================
    
    loki.write "loki_endpoint" {
      endpoint {
        url = "https://logging-loki-gateway-http.openshift-logging.svc:8080/api/logs/v1/application"
        
        // TLS configuration
        tls_config {
          insecure_skip_verify = true
        }
        
        // Authentication using ServiceAccount token
        bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
      }
      
      // External labels (applied to all logs)
      external_labels = {
        cluster = "redis-enterprise-demo",
        source  = "grafana-alloy",
      }
    }

