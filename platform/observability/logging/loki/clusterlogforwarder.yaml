---
# ServiceAccount for Log Collector
# Required by observability.openshift.io/v1 API
apiVersion: v1
kind: ServiceAccount
metadata:
  name: logcollector
  namespace: openshift-logging
  annotations:
    argocd.argoproj.io/sync-wave: "10"

---
# ClusterRoleBinding: Allow log collector to write logs to LokiStack
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: logcollector-loki-writer
  annotations:
    argocd.argoproj.io/sync-wave: "10"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-logging-write-application-logs
subjects:
- kind: ServiceAccount
  name: logcollector
  namespace: openshift-logging

---
# ClusterRoleBinding: Allow log collector to collect application logs
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: logcollector-application-logs
  annotations:
    argocd.argoproj.io/sync-wave: "10"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: collect-application-logs
subjects:
- kind: ServiceAccount
  name: logcollector
  namespace: openshift-logging

---
# ClusterLogForwarder for Redis Enterprise
# Collects logs from Redis namespaces and forwards to LokiStack
#
# This configuration:
# - Collects application logs from Redis namespaces
# - Forwards to LokiStack for storage
# - Enables log viewing in Grafana

apiVersion: observability.openshift.io/v1
kind: ClusterLogForwarder
metadata:
  name: instance
  namespace: openshift-logging
  annotations:
    argocd.argoproj.io/sync-wave: "11"
spec:
  # ServiceAccount (required in observability.openshift.io/v1 API)
  serviceAccount:
    name: logcollector

  # Inputs: Select logs from specific namespaces
  inputs:
  - name: redis-logs
    type: application
    application:
      includes:
      - namespace: redis-enterprise
      - namespace: redis-team1-dev
      - namespace: redis-team1-prod
      - namespace: redis-team2-dev
      - namespace: redis-team2-prod

  # Outputs: Where to send logs
  outputs:

  # LokiStack output
  - name: loki-redis
    type: loki
    loki:
      # URL to LokiStack gateway
      url: https://logging-loki-gateway-http.openshift-logging.svc:8080/api/logs/v1/application
      # Authentication using ServiceAccount token
      authentication:
        token:
          from: serviceAccount
    # TLS configuration
    tls:
      insecureSkipVerify: true

  # Pipelines: Connect inputs to outputs
  pipelines:

  # Pipeline 1: Redis Enterprise logs
  - name: redis-application-logs
    inputRefs:
    - redis-logs
    outputRefs:
    - loki-redis

---
# Alternative: Simpler configuration without filters
# Uncomment this if you want to collect ALL application logs
#
# apiVersion: logging.openshift.io/v1
# kind: ClusterLogForwarder
# metadata:
#   name: instance
#   namespace: openshift-logging
# spec:
#   outputs:
#   - name: loki-all
#     type: loki
#     loki:
#       url: https://logging-loki-gateway-http.openshift-logging.svc:8080/api/logs/v1/application
#       tenantKey: kubernetes.namespace_name
#     tls:
#       insecureSkipVerify: true
#   
#   pipelines:
#   - name: all-application-logs
#     inputRefs:
#     - application
#     outputRefs:
#     - loki-all

